function gitcommit-ai {

    Import-Module BurntToast -ErrorAction SilentlyContinue

    function Is-GenericCommit {
        param ($Subject)
        return $Subject -match '^chore:\s*(update|change|changes|code|staged changes)'
    }

    function Invoke-AI($Prompt) {
        $raw = $null
        for ($i = 1; $i -le 2 -and -not $raw; $i++) {
            try { $raw = $Prompt | ollama run mistral 2>$null } catch {}
            if (-not $raw) { Start-Sleep -Seconds 1 }
        }
        return $raw
    }

    # ----- COLLECT CHANGES ONCE -----
    $status = git --no-pager status --short

    $diff = git --no-pager diff --staged | Select-Object -First 300
    $source = "STAGED"

    if (-not $diff) {
        Write-Host "[WARN] No staged changes. Falling back to unstaged diff." -ForegroundColor Yellow
        $diff = git --no-pager diff | Select-Object -First 300
        $source = "UNSTAGED"
    }

    if (-not $diff) {
        Write-Host "[ERROR] No changes found." -ForegroundColor Red
        return
    }

    $basePrompt = @"
TASK:
Generate a SPECIFIC Git commit message.

RULES:
- Mention concrete entities (files, tables, features)
- Use verbs like add, remove, refactor, fix
- NEVER use generic phrases like "update code"

FORMAT:
type(scope): summary
- bullets (2â€“5)

--- GIT STATUS ---
$status

--- $source CHANGES ---
$diff
"@

    while ($true) {

        # ----- GENERATE -----
        $raw = Invoke-AI $basePrompt
        if (-not $raw) {
            Write-Host "[ERROR] AI failed." -ForegroundColor Red
            return
        }

        $lines = $raw -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ }
        $bullets = $lines | Where-Object { $_ -like "- *" } | Select-Object -First 5
        $subject = $lines | Where-Object {
            $_ -match '^(feat|fix|refactor|chore|docs|test|style|perf|ci|build)\(.+\): .+'
        } | Select-Object -First 1

        if (-not $subject -or (Is-GenericCommit $subject)) {
            Write-Host "[WARN] Generic commit detected. Regenerating..." -ForegroundColor Yellow
            continue
        }

        $final = @($subject) + $bullets
        $message = $final -join "`n"

        # ----- DISPLAY -----
        Write-Host ""
        Write-Host "AI Commit Message:" -ForegroundColor Cyan
        $final | ForEach-Object { Write-Host $_ }

        New-BurntToastNotification `
            -Text "gitcommit-ai", "Commit message generated. Press Enter to accept or N to regenerate."

        Write-Host ""
        Write-Host "Press [Enter] to copy | Type N + Enter to regenerate" -ForegroundColor Yellow
        $input = Read-Host ">"

        if ($input -match '^[Nn]$') {
            Write-Host "[INFO] Regenerating commit message..." -ForegroundColor Yellow
            continue
        }

        # ----- COPY & EXIT -----
        $message | clip
        Write-Host "[OK] Commit message copied to clipboard." -ForegroundColor Green

        New-BurntToastNotification `
            -Text "gitcommit-ai", "Commit message copied to clipboard."

        break
    }
}
